{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceNamePrefix": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]"
    },
    "vnetAddressSpaceCIDR": {
      "type": "string"
    }
  },
  "variables": {
    "platformBuildingBlocksDeploymentUrlBase": "https://raw.githubusercontent.com/DFE-Digital/bat-platform-building-blocks/7a4748a0cf366193d31434bd7796d483bd281385/templates/",
    "vnetDeploymentName": "[concat(parameters('resourceNamePrefix'), '-virtualnetwork')]",
    "vnetName": "[concat(parameters('resourceNamePrefix'), '-vn')]",
    "defaultSubnetAddressPrefix": "[parameters('vnetAddressSpaceCIDR')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2017-05-10",
      "name": "[variables('vnetDeploymentName')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(variables('platformBuildingBlocksDeploymentUrlBase'), 'virtual-network.json')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "vnetName": {
            "value": "[variables('vnetName')]"
          },
          "vnetAddressSpaceCIDR": {
            "value": "[parameters('vnetAddressSpaceCIDR')]"
          },
          "subnetConfiguration": {
            "value": [
              {
                "name": "default",
                "properties": {
                  "addressPrefix": "[variables('defaultSubnetAddressPrefix')]",
                  "serviceEndpoints": [
                    {
                      "service": "Microsoft.Storage",
                      "locations": ["westeurope", "northeurope"]
                    },
                    {
                      "service": "Microsoft.Sql",
                      "locations": ["westeurope"]
                    }
                  ],
                  "delegations": [],
                  "privateEndpointNetworkPolicies": "Enabled",
                  "privateLinkServiceNetworkPolicies": "Enabled"
                }
              }
            ]
          }
        }
      }
    }
  ],
  "outputs": {
    "resourceGroupId": {
      "type": "string",
      "value": "[resourceGroup().id]"
    },
    "defaultSubnetId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), 'default')]"
    }
  }
}
