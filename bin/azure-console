#!/bin/bash
set -e

ENVIRONMENT_NAME=$1

case $ENVIRONMENT_NAME in
  "production")
    SUBSCRIPTION="s189-teacher-services-cloud-production"
    NAMESPACE="srtl-production"
    ;;
  "test")
    SUBSCRIPTION="s189-teacher-services-cloud-test"
    NAMESPACE="srtl-test"
    ;;
  review-*)
    SUBSCRIPTION="s189-teacher-services-cloud-test"
    NAMESPACE="srtl-development"
    ;;
  *)
    echo "Could not find a known environment with the name: $ENVIRONMENT_NAME"
    exit 1
    ;;
esac

if [[ $ENVIRONMENT_NAME == "production" ]]; then
  echo "**********************************************************************************************************************"
  echo "You will need to make a PIM request to access the console"
  echo "Visit https://portal.azure.com/#blade/Microsoft_Azure_PIMCommon/ActivationMenuBlade/azurerbac"
  echo "and activate the 'Contributor' role for the 's118-teacherpaymentsservice-production' environment."
  echo "Once this has been approved, press enter to continue"
  echo "**********************************************************************************************************************"

  read -p "" -r

  echo "Logging out of Azure and back in to grab new tokens"
  if az account show > /dev/null; then
    az logout > /dev/null
  fi
fi

if ! az account show > /dev/null; then
  az login > /dev/null
fi

if [[ $ENVIRONMENT_NAME == "production" ]]; then
  echo "**********************************************************************************************************************"
  echo "IMPORTANT: Accessing the $ENVIRONMENT_NAME console in this way is VERY risky and should only be done as a last resort"
  echo "This should only be done in pairs, and mutating any live data is STRONGLY discouraged."
  echo "**********************************************************************************************************************"
fi

echo

read -p "Are you sure you want to continue? (y/n)" -n 1 -r
echo

if [[ $REPLY =~ ^[Yy]$ ]]; then
  az account set --subscription "$SUBSCRIPTION"

  kubectl -n $NAMESPACE exec -it deployment/claim-additional-payments-for-teaching-"$ENVIRONMENT_NAME"-worker -- rails console --sandbox
  exit 0
else
  echo "Quitting"
  exit 0
fi
