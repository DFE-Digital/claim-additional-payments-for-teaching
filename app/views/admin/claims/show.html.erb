<%= link_to "Back", admin_claims_path, class: "govuk-back-link" %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= render("shared/error_summary", instance: @check, errored_field_id_overrides: { "result": "check_result_approved" }) if @check.errors.any? %>

    <% if @claim.payroll_gender_missing? %>
      <div class="govuk-body-l govuk-flash__notice">
        This claim cannot be approved, the payroll gender is missing and the claim will need to be referred
      </div>
    <% end %>

    <% if @claim_ids_with_matching_attributes.present? %>
      <div class="govuk-body-l govuk-flash__warning">
        <a href="#claims-with-matches">Details in this claim match those in other claims</a>
      </div>
    <% end %>

    <h1 class="govuk-heading-xl">
      Claim <%= @claim.reference %>
    </h1>

    <%= render "admin/claims/answer_section", {heading: "Personal details", answers: admin_personal_details(@claim)} %>

    <%= render "admin/claims/answer_section", {heading: "Eligibility details", answers: admin_eligibility_answers(@claim.eligibility)} %>

    <%= render "admin/claims/answer_section", {heading: "Student loan details", answers: admin_student_loan_details(@claim)} %>

    <%= render "admin/claims/answer_section", {heading: "Submission details", answers: admin_submission_details(@claim)} %>

    <% if @claim.payroll_gender_missing? %>
      <div class="govuk-warning-text">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          <span class="govuk-warning-text__assistive">Warning</span>
          This claim cannot be approved, the payroll gender is missing and the claim will need to be referred
        </strong>
      </div>
    <% end %>

    <% if @claim_ids_with_matching_attributes.present? %>
      <table id="claims-with-matches" class="govuk-table govuk-!-margin-bottom-9">
        <caption class="govuk-table__caption govuk-heading-l">Claims with matching details</caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Claim</th>
            <th scope="col" class="govuk-table__header">Matching details</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <% @claim_ids_with_matching_attributes.each do |claim_id, matching_attributes| %>
            <tr class="govuk-table__row">
              <th scope="row" class="govuk-table__header"><%= link_to Claim.find(claim_id).reference, admin_claim_path(Claim.find(claim_id)), class: "govuk-link" %>
              <td class="govuk-table__cell">
                <ul class="govuk-list">
                <% matching_attributes.each do |attribute| %>
                  <li><%= attribute %></li>
                <% end %>
                </ul>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>

    <% if @check.persisted? %>
      <%= render "admin/claims/answer_section", {heading: "Claim decision details", answers: admin_check_details(@check)} %>
    <% else %>
      <%= form_for @check, url: admin_claim_checks_path(@claim) do |form| %>
        <%= form_group_tag @check do %>
          <fieldset class="govuk-fieldset govuk-!-margin-bottom-6">
            <legend class="govuk-fieldset__legend govuk-fieldset__legend--l govuk-!-margin-bottom-6">
              <h2 class="govuk-fieldset__heading">
                Claim decision
              </h2>
            </legend>
            <%= errors_tag @check, :result %>
            <div class="govuk-radios">
              <%= form.hidden_field :result %>
              <div class="govuk-radios__item">
                <%= form.radio_button(:result, "approved", class: "govuk-radios__input", disabled: @claim.payroll_gender_missing?) %>
                <%= form.label "result_approved", "Approve", class: "govuk-label govuk-radios__label" %>
              </div>
              <div class="govuk-radios__item">
                <%= form.radio_button(:result, "rejected", class: "govuk-radios__input") %>
                <%= form.label "result_rejected", "Reject", class: "govuk-label govuk-radios__label" %>
              </div>
            </div>
          </fieldset>
          <%= form.label :notes, "Decision notes", class: "govuk-label govuk-label--m" %>
          <span class="govuk-hint">
            Please write a brief note explaining why this claim has been rejected or approved.
          </span>
          <%= form.text_area :notes, class: "govuk-textarea", rows: 5 %>
          <%= form.submit "Submit", class: "govuk-button" %>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>
