<% content_for(:page_title) { page_title("Tasks") } %>

<% content_for :back_link do %>
  <%= govuk_back_link href: claims_backlink_path %>
<% end %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    <h1 class="govuk-heading-l">
      <%= @presenter.policy.short_name %>
    </h1>

    <section id="policy-buttons">
      <% Policies.all.select(&:active?).each do |policy| %>
        <%= govuk_button_link_to(
          policy.short_name,
          admin_task_lists_path(
            @presenter.applied_params(
              policy_name: policy.locale_key,
              statuses: {}
            )
          ),
          secondary: true,
        ) %>
      <% end %>
    </section>

    <section id="toggle-filter-controls">
      <% if @presenter.show_filter_controls? %>
        <%= govuk_button_link_to(
          "Hide filters",
          admin_task_lists_path(
            @presenter.applied_params(show_filter_controls: false)
          ),
          secondary: true,
        ) %>
      <% else %>
        <%= govuk_button_link_to(
          "Show filters",
          admin_task_lists_path(
            @presenter.applied_params(show_filter_controls: true)
          ),
          secondary: true,
        ) %>
      <% end %>
    </section>

    <section id="filter-controls" class="<%= class_names(
      "govuk-visually-hidden": !@presenter.show_filter_controls?
    ) %>">
      <%= form_with(
        model: @presenter,
        url: admin_task_lists_path,
        method: :get,
        builder: GOVUKDesignSystemFormBuilder::FormBuilder
      ) do |f| %>
        <%= f.hidden_field :policy_name, value: f.object.policy.locale_key %>
        <%= f.hidden_field(
          :show_filter_controls,
          value: f.object.show_filter_controls?
        ) %>

        <div class="govuk-button-group">
          <%= govuk_button_link_to(
            "Check all",
            admin_task_lists_path(
              f.object.applied_params(statuses: f.object.all_statuses)
            ),
            secondary: true,
          ) %>
          <%= govuk_button_link_to(
            "Uncheck all",
            admin_task_lists_path(f.object.applied_params(
              statuses: {},
              clear_statuses: true
            )),
            secondary: true,
          ) %>
        </div>

        <%= f.fields_for :statuses do |ff| %>
          <% f.object.policy_tasks.each_slice(3) do |task_keys| %>
            <div class="govuk-grid-row">
              <% task_keys.each do |task_key| %>
                <div class="govuk-grid-column-one-third">
                  <%= ff.govuk_check_boxes_fieldset(
                    task_key,
                    legend: {
                      text: I18n.t("admin.tasks.#{task_key}.name"),
                      size: "s",
                    }
                  ) do %>
                    <% f.object.task_statuses(task_key).each do |status| %>
                      <%= ff.govuk_check_box(
                        task_key,
                        status,
                        label: { text: status.humanize },
                        checked: f.object.selected_statuses_for(task_key).include?(status),
                      ) %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>

        <%= f.govuk_collection_select(
          :assignee_id,
          f.object.assignees,
          :id,
          :full_name,
          label: { text: "Assigned to" },
        ) %>


        <%= f.govuk_submit("Apply") %>
      <% end %>
    </section>

    <section id="csv-export">
      <%= govuk_button_link_to(
        "Export CSV",
        admin_task_lists_path(@presenter.applied_params(format: :csv)),
        secondary: true,
      ) %>
    </section>

    <div class="overflow-x-auto">
      <%= govuk_table do |table| %>
        <% table.with_caption(
          size: "m",
          text: "#{@presenter.claims.count} claims found"
        ) %>

        <% table.with_head do |head| %>
          <% head.with_row do |row| %>
            <% row.with_cell(text: "Reference") %>
            <% row.with_cell(text: "Assigned to") %>
            <% row.with_cell(text: "Decision&nbsp;deadline".html_safe) %>
            <% @presenter.task_names.each do |task_name| %>
              <% row.with_cell(text: task_name) %>
            <% end %>
            <% row.with_cell(text: "Held") %>
          <% end %>
        <% end %>

        <% table.with_body do |body| %>
          <% @presenter.claims.each do |claim| %>
            <% body.with_row do |row| %>
              <% row.with_cell(
                text: govuk_link_to(claim.reference, admin_claim_path(claim.id))
              ) %>
              <% row.with_cell(text: claim.assigned_to&.full_name || "-") %>
              <% row.with_cell(text: l(claim.decision_deadline_date)) %>
              <% claim.tasks.each do |task| %>
                <% row.with_cell(
                  text: task_status_content_tag(
                    status_colour: task.colour,
                    status: task.display_status,
                  )
                ) %>
              <% end %>
              <% if claim.held? %>
                <% row.with_cell(
                  text: task_status_content_tag(
                    status_colour: "red",
                    status: "Held",
                  )
                ) %>
              <% else %>
                <% row.with_cell(text: "No") %>
              <% end %>
            <% end %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
