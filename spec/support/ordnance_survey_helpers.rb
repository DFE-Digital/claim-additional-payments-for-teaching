module OrdnanceSurveyHelpers
  def result_sets
    {
      "SO16 9FX": [
        {
          DPA: {
            UPRN: "100062039919",
            UDPRN: "22785699",
            ADDRESS: "FLAT 1, MILLBROOK TOWER, WINDERMERE AVENUE, SOUTHAMPTON, SO16 9FX",
            SUB_BUILDING_NAME: "FLAT 1",
            BUILDING_NAME: "MILLBROOK TOWER",
            THOROUGHFARE_NAME: "WINDERMERE AVENUE",
            POST_TOWN: "SOUTHAMPTON",
            POSTCODE: "SO16 9FX",
            RPC: "2",
            X_COORDINATE: 438092.0,
            Y_COORDINATE: 114637.0,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD06",
            CLASSIFICATION_CODE_DESCRIPTION: "Self Contained Flat (Includes Maisonette / Apartment)",
            LOCAL_CUSTODIAN_CODE: 1780,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "SOUTHAMPTON",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: "2",
            BLPU_STATE_CODE_DESCRIPTION: "In use",
            TOPOGRAPHY_LAYER_TOID: "osgb1000016364569",
            PARENT_UPRN: "100062691379",
            LAST_UPDATE_DATE: "12/11/2018",
            ENTRY_DATE: "03/05/2001",
            BLPU_STATE_DATE: "11/12/2007",
            LANGUAGE: "EN",
            MATCH: 1.0,
            MATCH_DESCRIPTION: "EXACT"
          }
        },
        {
          DPA: {
            UPRN: "100062039928",
            UDPRN: "22785700",
            ADDRESS: "FLAT 10, MILLBROOK TOWER, WINDERMERE AVENUE, SOUTHAMPTON, SO16 9FX",
            SUB_BUILDING_NAME: "FLAT 10",
            BUILDING_NAME: "MILLBROOK TOWER",
            THOROUGHFARE_NAME: "WINDERMERE AVENUE",
            POST_TOWN: "SOUTHAMPTON",
            POSTCODE: "SO16 9FX",
            RPC: "2",
            X_COORDINATE: 438092.0,
            Y_COORDINATE: 114637.0,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD06",
            CLASSIFICATION_CODE_DESCRIPTION: "Self Contained Flat (Includes Maisonette / Apartment)",
            LOCAL_CUSTODIAN_CODE: 1780,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "SOUTHAMPTON",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: "2",
            BLPU_STATE_CODE_DESCRIPTION: "In use",
            TOPOGRAPHY_LAYER_TOID: "osgb1000016364569",
            PARENT_UPRN: "100062691379",
            LAST_UPDATE_DATE: "12/11/2018",
            ENTRY_DATE: "03/05/2001",
            BLPU_STATE_DATE: "11/12/2007",
            LANGUAGE: "EN",
            MATCH: 1.0,
            MATCH_DESCRIPTION: "EXACT"
          }
        },
        {
          DPA: {
            UPRN: "100062039929",
            UDPRN: "22785701",
            ADDRESS: "FLAT 11, MILLBROOK TOWER, WINDERMERE AVENUE, SOUTHAMPTON, SO16 9FX",
            SUB_BUILDING_NAME: "FLAT 11",
            BUILDING_NAME: "MILLBROOK TOWER",
            THOROUGHFARE_NAME: "WINDERMERE AVENUE",
            POST_TOWN: "SOUTHAMPTON",
            POSTCODE: "SO16 9FX",
            RPC: "2",
            X_COORDINATE: 438092.0,
            Y_COORDINATE: 114637.0,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD06",
            CLASSIFICATION_CODE_DESCRIPTION: "Self Contained Flat (Includes Maisonette / Apartment)",
            LOCAL_CUSTODIAN_CODE: 1780,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "SOUTHAMPTON",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: "2",
            BLPU_STATE_CODE_DESCRIPTION: "In use",
            TOPOGRAPHY_LAYER_TOID: "osgb1000016364569",
            PARENT_UPRN: "100062691379",
            LAST_UPDATE_DATE: "12/11/2018",
            ENTRY_DATE: "03/05/2001",
            BLPU_STATE_DATE: "11/12/2007",
            LANGUAGE: "EN",
            MATCH: 1.0,
            MATCH_DESCRIPTION: "EXACT"
          }
        }
      ],
      "SE13 7UN": [
        {
          DPA: {
            UPRN: "100022018431",
            UDPRN: "21645210",
            ADDRESS: "1, WEARSIDE ROAD, LONDON, SE13 7UN",
            BUILDING_NUMBER: "1",
            THOROUGHFARE_NAME: "WEARSIDE ROAD",
            POST_TOWN: "LONDON",
            POSTCODE: "SE13 7UN",
            RPC: "1",
            X_COORDINATE: 537944,
            Y_COORDINATE: 174994,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD04",
            CLASSIFICATION_CODE_DESCRIPTION: "Terraced",
            LOCAL_CUSTODIAN_CODE: 5690,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "LEWISHAM",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: nil,
            BLPU_STATE_CODE_DESCRIPTION: "Unknown/Not applicable",
            TOPOGRAPHY_LAYER_TOID: "osgb1000041787230",
            LAST_UPDATE_DATE: "10/02/2016",
            ENTRY_DATE: "15/09/2001",
            LANGUAGE: "EN",
            MATCH: 1,
            MATCH_DESCRIPTION: "EXACT"
          }
        },
        {
          DPA: {
            UPRN: "100022018432",
            UDPRN: "21645221",
            ADDRESS: "2, WEARSIDE ROAD, LONDON, SE13 7UN",
            BUILDING_NUMBER: "2",
            THOROUGHFARE_NAME: "WEARSIDE ROAD",
            POST_TOWN: "LONDON",
            POSTCODE: "SE13 7UN",
            RPC: "1",
            X_COORDINATE: 537915,
            Y_COORDINATE: 174991,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD04",
            CLASSIFICATION_CODE_DESCRIPTION: "Terraced",
            LOCAL_CUSTODIAN_CODE: 5690,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "LEWISHAM",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: nil,
            BLPU_STATE_CODE_DESCRIPTION: "Unknown/Not applicable",
            TOPOGRAPHY_LAYER_TOID: "osgb1000041787220",
            LAST_UPDATE_DATE: "10/02/2016",
            ENTRY_DATE: "15/09/2001",
            LANGUAGE: "EN",
            MATCH: 1,
            MATCH_DESCRIPTION: "EXACT"
          }
        },
        {
          DPA: {
            UPRN: "100022018468",
            UDPRN: "21645235",
            ADDRESS: "38A, WEARSIDE ROAD, LONDON, SE13 7UN",
            BUILDING_NAME: "38A",
            THOROUGHFARE_NAME: "WEARSIDE ROAD",
            POST_TOWN: "LONDON",
            POSTCODE: "SE13 7UN",
            RPC: "2",
            X_COORDINATE: 537895,
            Y_COORDINATE: 175090,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD06",
            CLASSIFICATION_CODE_DESCRIPTION: "Self Contained Flat (Includes Maisonette / Apartment)",
            LOCAL_CUSTODIAN_CODE: 5690,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "LEWISHAM",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: nil,
            BLPU_STATE_CODE_DESCRIPTION: "Unknown/Not applicable",
            TOPOGRAPHY_LAYER_TOID: "osgb1000041792638",
            LAST_UPDATE_DATE: "23/09/2018",
            ENTRY_DATE: "15/09/2001",
            LANGUAGE: "EN",
            MATCH: 1,
            MATCH_DESCRIPTION: "EXACT"
          }
        },
        {
          DPA: {
            UPRN: "100022018469",
            UDPRN: "21645236",
            ADDRESS: "38B-38C, WEARSIDE ROAD, LONDON, SE13 7UN",
            BUILDING_NAME: "38B-38C",
            THOROUGHFARE_NAME: "WEARSIDE ROAD",
            POST_TOWN: "LONDON",
            POSTCODE: "SE13 7UN",
            RPC: "1",
            X_COORDINATE: 537902,
            Y_COORDINATE: 175080,
            STATUS: "APPROVED",
            LOGICAL_STATUS_CODE: "1",
            CLASSIFICATION_CODE: "RD06",
            CLASSIFICATION_CODE_DESCRIPTION: "Self Contained Flat (Includes Maisonette / Apartment)",
            LOCAL_CUSTODIAN_CODE: 5690,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "LEWISHAM",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: nil,
            BLPU_STATE_CODE_DESCRIPTION: "Unknown/Not applicable",
            TOPOGRAPHY_LAYER_TOID: "osgb1000041792637",
            LAST_UPDATE_DATE: "10/02/2016",
            ENTRY_DATE: "15/09/2001",
            LANGUAGE: "EN",
            MATCH: 1,
            MATCH_DESCRIPTION: "EXACT"
          }
        }
      ],
      "19, BD73BE": [
        {
          DPA: {
            UPRN: "100051230006",
            UDPRN: "1593790",
            ADDRESS: "19, TURNER PLACE, BRADFORD, BD7 3BE",
            BUILDING_NUMBER: "19",
            THOROUGHFARE_NAME: "TURNER PLACE",
            POST_TOWN: "BRADFORD",
            POSTCODE: "BD7 3BE",
            RPC: "1",
            X_COORDINATE: 414965.0,
            Y_COORDINATE: 432199.0,
            STATUS: "HISTORICAL",
            LOGICAL_STATUS_CODE: "8",
            CLASSIFICATION_CODE: "RD04",
            CLASSIFICATION_CODE_DESCRIPTION: "Terraced",
            LOCAL_CUSTODIAN_CODE: 4705,
            LOCAL_CUSTODIAN_CODE_DESCRIPTION: "BRADFORD MDC",
            POSTAL_ADDRESS_CODE: "D",
            POSTAL_ADDRESS_CODE_DESCRIPTION: "A record which is linked to PAF",
            BLPU_STATE_CODE: "4",
            BLPU_STATE_CODE_DESCRIPTION: "No longer existing",
            TOPOGRAPHY_LAYER_TOID: "osgb1000031905429",
            LAST_UPDATE_DATE: "11/05/2019",
            ENTRY_DATE: "05/04/2001",
            BLPU_STATE_DATE: "07/05/2019",
            LANGUAGE: "EN",
            MATCH: 0.4,
            MATCH_DESCRIPTION: "NO MATCH"
          }
        }
      ]
    }
  end

  def stub_search_places_index(claim:, overrides: nil)
    defaults = {
      query: WebMock::API.hash_including(
        {
          postcode: claim.postcode.delete(" "),
          key: "api-key-value"
        }
      ),
      # truncated resultset (actual is 50, supplied 3) since not using any capture and replay tools eg VCR
      body: {
        results: result_sets[:"#{claim.postcode}"]
      },
      status: 200
    }

    args = overrides ? merge_recursively(defaults, overrides) : defaults

    stub_request(:get, "https://api.os.uk/search/places/v1/postcode?key=api-key-value&postcode=#{claim.postcode.delete(" ")}")
      .with(
        headers: {
          "Content-Type" => "application/json",
          "Expect" => "",
          "User-Agent" => "Typhoeus - https://github.com/typhoeus/typhoeus"
        }
      )
      .to_return(
        status: 200,
        body: args[:body].to_json,
        headers: {}
      )
  end

  def stub_search_places_show(claim:, overrides: nil)
    query = [claim.address_line_1, claim.postcode.delete(" ")].join(", ")
    defaults = {
      query: WebMock::API.hash_including(
        {
          query: query,
          key: "api-key-value",
          maxresults: 1,
          minmatch: 0.4
        }
      ),
      body: {
        results: result_sets[:"#{query}"]
      },
      status: 200
    }

    args = overrides ? merge_recursively(defaults, overrides) : defaults

    stub_request(:get, "https://api.os.uk/search/places/v1/find?key=api-key-value&maxresults=1&minmatch=0.4&query=#{query}")
      .with(
        headers: {
          "Content-Type" => "application/json",
          "Expect" => "",
          "User-Agent" => "Typhoeus - https://github.com/typhoeus/typhoeus"
        }
      )
      .to_return(
        status: 200,
        body: args[:body].to_json,
        headers: {}
      )
  end

  private

  def merge_recursively(a, b)
    a.merge!(b) do |key, a_item, b_item|
      if a_item.is_a?(Hash)
        merge_recursively(a_item, b_item)
      else
        b_item
      end
    end
  end
end
